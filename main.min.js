const c = document.getElementById("gameCanvas"),
      ctx = c.getContext("2d"),
      W = c.width,
      H = c.height,
      assets = {
        sprite: new Image(),
        brickBreakSfx: new Audio(),
        preview: new Image()
      };
let loaded = 0;
const total = 3,
      startEvt = "start",
      firstEvt = "first_interaction",
      completeEvt = "complete",
      clickEvt = "click";

function assetLoaded() {
  if (++loaded === total) startPlayable();
}

assets.sprite.src = "assets/spritesheet.png";
assets.sprite.onload = assetLoaded;
assets.brickBreakSfx.src = "assets/brick_break.ogg";
assets.brickBreakSfx.oncanplaythrough = assetLoaded;
assets.preview.src = "assets/preview.jpg";
assets.preview.onload = assetLoaded;

let paddle = { x: W / 2 - 40, y: H - 20, w: 80, h: 12 },
    ball = { x: W / 2, y: H - 40, r: 6, dx: 2, dy: -2 },
    ROWS = 3,
    COLS = 5,
    BRW = 50,
    BRH = 20,
    bricks = [],
    hasInteracted = false,
    animPlay = false,
    pointerX = null;

function sendEvent(e) {
  if (window.PlayableAdSdk && typeof window.PlayableAdSdk.reportEvent === "function") {
    window.PlayableAdSdk.reportEvent(e);
  }
}

function startPlayable() {
  c.addEventListener("pointerdown", e => {
    if (!hasInteracted) {
      hasInteracted = true;
      animPlay = true;
      sendEvent(firstEvt);
      gameLoop();
    }
  });
  c.addEventListener("pointermove", e => {
    if (hasInteracted) {
      const r = c.getBoundingClientRect();
      pointerX = (e.clientX - r.left) * (W / r.width);
    }
  });
  sendEvent(startEvt);
  drawInstr();
}

function drawInstr() {
  ctx.fillStyle = "#111";
  ctx.fillRect(0, 0, W, H);
  ctx.fillStyle = "#fff";
  ctx.font = "18px sans-serif";
  ctx.textAlign = "center";
  ctx.fillText("TAP TO BREAK BRICKS", W / 2, H / 2);
}

for (let r = 0; r < ROWS; r++) {
  for (let c0 = 0; c0 < COLS; c0++) {
    bricks.push({
      x: c0 * (BRW + 4) + 20,
      y: r * (BRH + 4) + 60,
      w: BRW,
      h: BRH,
      broken: false
    });
  }
}

function drawP() {
  ctx.fillStyle = "#fff";
  ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
}

function drawB() {
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
  ctx.fillStyle = "#ffeb3b";
  ctx.fill();
  ctx.closePath();
}

function drawBricks() {
  bricks.forEach(b => {
    if (!b.broken) {
      ctx.fillStyle = "#e91e63";
      ctx.fillRect(b.x, b.y, b.w, b.h);
    }
  });
}

function update() {
  if (!animPlay) return;

  if (pointerX !== null) {
    paddle.x = Math.min(Math.max(pointerX - paddle.w / 2, 0), W - paddle.w);
  }

  ball.x += ball.dx;
  ball.y += ball.dy;

  if (ball.x + ball.r > W || ball.x - ball.r < 0) {
    ball.dx *= -1;
  }
  if (ball.y - ball.r < 0) {
    ball.dy *= -1;
  }

  if (
    ball.y + ball.r > paddle.y &&
    ball.x > paddle.x &&
    ball.x < paddle.x + paddle.w
  ) {
    ball.dy *= -1;
    const hitPos = (ball.x - (paddle.x + paddle.w / 2)) / (paddle.w / 2);
    ball.dx = 2 * hitPos;
  }

  bricks.forEach(b => {
    if (
      !b.broken &&
      ball.x > b.x &&
      ball.x < b.x + b.w &&
      ball.y - ball.r < b.y + b.h &&
      ball.y + ball.r > b.y
    ) {
      b.broken = true;
      ball.dy *= -1;
      assets.brickBreakSfx.currentTime = 0;
      assets.brickBreakSfx.play();
    }
  });

  const all = bricks.every(b => b.broken);
  if (all) {
    animPlay = false;
    setTimeout(showCTA, 200);
  }

  if (ball.y - ball.r > H) {
    animPlay = false;
    setTimeout(showCTA, 200);
  }
}

function gameLoop() {
  ctx.clearRect(0, 0, W, H);
  drawBricks();
  drawP();
  drawB();
  update();
  if (animPlay) requestAnimationFrame(gameLoop);
}

function showCTA() {
  sendEvent(completeEvt);
  const o = document.getElementById("ctaOverlay");
  o.style.display = "flex";
  document.getElementById("ctaButton").onclick = function() {
    sendEvent(clickEvt);
    window.open(
      "https://apps.apple.com/us/app/brick-blaster-cash-win-money/id6466097629",
      "_blank"
    );
  };
}
